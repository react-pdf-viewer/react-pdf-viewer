"use strict";var e=require("@react-pdf-viewer/core");function t(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var i=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,i.get?i:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var n,i=t(require("react"));!function(e){e.NoSelection="NoSelection",e.Selecting="Selecting",e.Selected="Selected",e.Selection="Selection",e.ClickDragging="ClickDragging",e.ClickDragged="ClickDragged"}(n||(n={}));var r,a,o={height:0,left:0,pageIndex:-1,top:0,width:0},c={highlightAreas:[],selectionRegion:o,type:n.NoSelection},g={highlightAreas:[],selectionRegion:o,type:n.Selecting},l=function(e){var t=e.canvasLayerRef,r=e.canvasLayerRendered,a=e.pageIndex,o=e.store,g=e.textLayerRef,l=e.textLayerRendered,h=i.useRef(),s=i.useRef(document.body.style.cursor),u=i.useRef({x:0,y:0}),d=i.useRef({top:0,left:0}),f=function(){var e=h.current;e&&e.classList.add("rpv-highlight__click-drag--hidden")},p=function(e){var t=g.current,i=h.current;if(e.altKey&&t&&i&&0===e.button){e.preventDefault(),document.body.style.cursor="crosshair";var r=t.getBoundingClientRect(),a={x:e.clientX,y:e.clientY};u.current=a;var c={top:100*(a.y-r.top)/r.height,left:100*(a.x-r.left)/r.width};d.current=c,i.style.top="".concat(c.top,"%"),i.style.left="".concat(c.left,"%"),i.style.height="0px",i.style.width="0px",document.addEventListener("mousemove",v),document.addEventListener("mouseup",w),o.updateCurrentValue("highlightState",(function(e){return Object.assign({},e,{type:n.ClickDragging})}))}},v=function(e){var t=g.current,n=h.current;if(t&&n){e.preventDefault();var i=e.clientX-u.current.x,r=e.clientY-u.current.y,a=t.getBoundingClientRect();n.classList.contains("rpv-highlight__click-drag--hidden")&&n.classList.remove("rpv-highlight__click-drag--hidden");var o=Math.min(100-d.current.left,100*i/a.width),c=Math.min(100-d.current.top,100*r/a.height);n.style.width="".concat(o,"%"),n.style.height="".concat(c,"%")}},m=function(e){"Escape"===e.key&&o.get("highlightState").type===n.ClickDragged&&(e.preventDefault(),f(),o.update("highlightState",c))},x=function(e){var t=h.current;t&&(o.get("highlightState").type===n.NoSelection&&e.target!==t&&f())},w=function(e){e.preventDefault(),document.removeEventListener("mousemove",v),document.removeEventListener("mouseup",w),y();var i=h.current,r=t.current;if(i&&r){var c,g,l={pageIndex:a,top:parseFloat(i.style.top.slice(0,-1)),left:parseFloat(i.style.left.slice(0,-1)),height:parseFloat(i.style.height.slice(0,-1)),width:parseFloat(i.style.width.slice(0,-1))},s=(c=document.createElement("canvas"),g=window.devicePixelRatio||1,function(e,t){var n=e.getBoundingClientRect(),i=t.left*n.width/100,r=t.top*n.height/100,a=t.width*n.width/100,o=t.height*n.height/100,l=c.getContext("2d");return c.width=a,c.height=o,null==l||l.drawImage(e,i*g,r*g,a*g,o*g,0,0,a,o),c.toDataURL("image/png")})(r,l),u={highlightAreas:[l],previewImage:s,selectionRegion:l,type:n.ClickDragged};o.update("highlightState",u)}},y=function(){s.current?document.body.style.cursor=s.current:document.body.style.removeProperty("cursor")},S=function(e){(e.type===n.Selection||e.type===n.ClickDragging&&e.selectionRegion.pageIndex!==a)&&f()};return i.useEffect((function(){return o.subscribe("highlightState",S),function(){o.unsubscribe("highlightState",S)}}),[]),i.useEffect((function(){var e=t.current,n=g.current;if(r&&l&&e&&n){n.addEventListener("mousedown",p);var i={capture:!0};return document.addEventListener("keydown",m),document.addEventListener("click",x,i),function(){n.removeEventListener("mousedown",p),document.removeEventListener("click",x,i),document.removeEventListener("keydown",m)}}}),[l]),i.createElement("div",{ref:h,className:"rpv-highlight__click-drag rpv-highlight__click-drag--hidden"})},h=function(e){return e>=0?e:360+e},s=function(e,t){switch(h(t)){case 90:return{height:"".concat(e.width,"%"),position:"absolute",right:"".concat(e.top,"%"),top:"".concat(e.left,"%"),width:"".concat(e.height,"%")};case 180:return{bottom:"".concat(e.top,"%"),height:"".concat(e.height,"%"),position:"absolute",right:"".concat(e.left,"%"),width:"".concat(e.width,"%")};case 270:return{height:"".concat(e.width,"%"),position:"absolute",left:"".concat(e.top,"%"),bottom:"".concat(e.left,"%"),width:"".concat(e.height,"%")};default:return{height:"".concat(e.height,"%"),position:"absolute",top:"".concat(e.top,"%"),left:"".concat(e.left,"%"),width:"".concat(e.width,"%")}}},u=function(e){var t=e.area,n=e.rotation;return i.createElement("div",{className:"rpv-highlight__selected-text",style:s(t,n)})},d=function(e){var t=i.useState(e.get("rotation")||0),n=t[0],r=t[1],a=function(e){return r(e)};return i.useEffect((function(){return e.subscribe("rotation",a),function(){e.unsubscribe("rotation",a)}}),[]),{rotation:n}},f=function(e){var t=e.pageIndex,r=e.renderHighlightContent,a=e.renderHighlightTarget,o=e.renderHighlights,g=e.store,l=i.useState(g.get("highlightState")),h=l[0],f=l[1],p=d(g).rotation,v=function(e){return f(e)},m=function(){window.getSelection().removeAllRanges(),g.update("highlightState",c)};i.useEffect((function(){return g.subscribe("highlightState",v),function(){g.unsubscribe("highlightState",v)}}),[]);var x=h.type===n.Selection?h.highlightAreas.filter((function(e){return e.pageIndex===t})):[];return i.createElement(i.Fragment,null,a&&(h.type===n.Selected||h.type===n.ClickDragged)&&h.selectionRegion.pageIndex===t&&a({highlightAreas:h.highlightAreas,previewImage:h.previewImage||"",selectedText:h.selectedText||"",selectionRegion:h.selectionRegion,selectionData:h.selectionData,cancel:m,toggle:function(){var e=Object.assign({},h,{type:n.Selection});g.update("highlightState",e),window.getSelection().removeAllRanges()}}),r&&h.type==n.Selection&&h.selectionRegion.pageIndex===t&&r({highlightAreas:h.highlightAreas,previewImage:h.previewImage||"",selectedText:h.selectedText||"",selectionRegion:h.selectionRegion,selectionData:h.selectionData,cancel:m}),x.length>0&&i.createElement("div",null,x.map((function(e,t){return i.createElement(u,{key:t,area:e,rotation:p})}))),o&&o({pageIndex:t,rotation:p,getCssProperties:s}))},p="data-highlight-text-layer",v="data-highlight-text-page",m=function(e,t,n){var i=e.cloneNode(!0);e.parentNode.appendChild(i);var r=i.firstChild,a=new Range;a.setStart(r,t),a.setEnd(r,n);var o=document.createElement("span");a.surroundContents(o);var c=o.getBoundingClientRect();return i.parentNode.removeChild(i),c},x=function(e,t,n,i,r,a){if(n<r){var o=e.slice(n,n+1).map((function(e){return e.textContent.substring(i).trim()})).join(" "),c=e.slice(n+1,r).map((function(e){return e.textContent.trim()})).join(" "),g=e.slice(r,r+1).map((function(e){return e.textContent.substring(0,a||e.textContent.length)})).join(" "),l="".concat(o," ").concat(c," ").concat(g);return{divTexts:e.slice(n,r+1).map((function(e,i){return{divIndex:n+i,pageIndex:t,textContent:e.textContent}})),wholeText:l}}var h=e[n];l=h.textContent.substring(i,a||h.textContent.length).trim();return{divTexts:[{divIndex:n,pageIndex:t,textContent:h.textContent}],wholeText:l}};!function(e){e.SameDiv="SameDiv",e.DifferentDivs="DifferentDivs",e.DifferentPages="DifferentPages"}(r||(r={})),exports.Trigger=void 0,(a=exports.Trigger||(exports.Trigger={})).None="None",a.TextSelection="TextSelection";var w=["","\n"],y=function(e){var t=e.store,a=d(t).rotation,o=i.useRef(null),c=i.useState(!1),g=c[0],l=c[1],s=i.useState(t.get("trigger")),u=s[0],f=s[1],y=function(e){var t=e();o.current=t,l(!!t)},S=function(e){return f(e)},b=function(){var e=document.getSelection(),i=t.get("highlightState");if((i.type===n.NoSelection||i.type===n.Selected)&&e.rangeCount>0&&-1===w.indexOf(e.toString())){var o,c,g=e.getRangeAt(0),l=g.startContainer.parentNode,s=g.endContainer.parentNode,u=s instanceof HTMLElement&&s.hasAttribute(p);if(l&&l.parentNode==g.endContainer?c=(o=l).textContent.length:u&&0==g.endOffset?c=(o=g.endContainer.previousSibling).textContent.length:u?(o=g.endContainer,c=g.endOffset):(o=s,c=g.endOffset),l instanceof HTMLElement&&o instanceof HTMLElement){var d=parseInt(l.getAttribute(v),10),f=parseInt(o.getAttribute(v),10),y=l.parentElement,S=o.parentElement,b=y.getBoundingClientRect(),C=[].slice.call(y.querySelectorAll("[".concat(v,"]"))),E=C.indexOf(l),R=S.getBoundingClientRect(),D=[].slice.call(S.querySelectorAll("[".concat(v,"]"))),I=D.indexOf(o),L=g.startOffset,T=r.DifferentPages;switch(!0){case d===f&&E===I:T=r.SameDiv;break;case d===f&&E<I:T=r.DifferentDivs;break;default:T=r.DifferentPages}var k=function(e,t,n){return Array(t-e+1).fill(0).map((function(t,i){return n[e+i].getBoundingClientRect()}))},A=[];switch(T){case r.SameDiv:var P=m(l,L,c);A=[{height:100*P.height/b.height,left:100*(P.left-b.left)/b.width,pageIndex:d,top:100*(P.top-b.top)/b.height,width:100*P.width/b.width}];break;case r.DifferentDivs:A=[m(l,L,l.textContent.length)].concat(k(E+1,I-1,C)).concat([m(o,0,c)]).map((function(e){return{height:100*e.height/b.height,left:100*(e.left-b.left)/b.width,pageIndex:d,top:100*(e.top-b.top)/b.height,width:100*e.width/b.width}}));break;case r.DifferentPages:var O=[m(l,L,l.textContent.length)].concat(k(E+1,C.length-1,C)).map((function(e){return{height:100*e.height/b.height,left:100*(e.left-b.left)/b.width,pageIndex:d,top:100*(e.top-b.top)/b.height,width:100*e.width/b.width}})),N=k(0,I-1,D).concat([m(o,0,c)]).map((function(e){return{height:100*e.height/R.height,left:100*(e.left-R.left)/R.width,pageIndex:f,top:100*(e.top-R.top)/R.height,width:100*e.width/R.width}}));A=O.concat(N)}var _,j="",H=[];switch(T){case r.SameDiv:var M=x(C,d,E,L,E,c);j=M.wholeText,H=M.divTexts;break;case r.DifferentDivs:var q=x(C,d,E,L,I,c);j=q.wholeText,H=q.divTexts;break;case r.DifferentPages:var B=x(C,d,E,L,C.length),F=x(D,f,0,0,I,c);j="".concat(B.wholeText,"\n").concat(F.wholeText),H=B.divTexts.concat(F.divTexts)}if(A.length>0)_=A[A.length-1];else{var V=o.getBoundingClientRect();_={height:100*V.height/R.height,left:100*(V.left-R.left)/R.width,pageIndex:f,top:100*(V.top-R.top)/R.height,width:100*V.width/R.width}}var Y={divTexts:H,selectedText:j,startPageIndex:d,endPageIndex:f,startOffset:L,startDivIndex:E,endOffset:c,endDivIndex:I},X={type:n.Selected,selectedText:j,highlightAreas:A.map((function(e){return function(e,t){switch(h(t)){case 90:return{height:e.width,left:e.top,pageIndex:e.pageIndex,top:100-e.width-e.left,width:e.height};case 180:return{height:e.height,left:100-e.width-e.left,pageIndex:e.pageIndex,top:100-e.height-e.top,width:e.width};case 270:return{height:e.width,left:100-e.height-e.top,pageIndex:e.pageIndex,top:e.left,width:e.height};default:return e}}(e,a)})),selectionData:Y,selectionRegion:_};t.update("highlightState",X)}}};return i.useEffect((function(){var e=o.current;if(e&&u!==exports.Trigger.None)return e.addEventListener("mouseup",b),function(){e.removeEventListener("mouseup",b)}}),[g,u,a]),i.useEffect((function(){return t.subscribe("getPagesContainer",y),t.subscribe("trigger",S),function(){t.unsubscribe("getPagesContainer",y),t.unsubscribe("trigger",S)}}),[]),i.createElement(i.Fragment,null)},S="rpv-highlight__selected-end";exports.MessageIcon=function(){return i.createElement(e.Icon,{size:16},i.createElement("path",{d:"M23.5,17a1,1,0,0,1-1,1h-11l-4,4V18h-6a1,1,0,0,1-1-1V3a1,1,0,0,1,1-1h21a1,1,0,0,1,1,1Z"}),i.createElement("path",{d:"M5.5 12L18.5 12"}),i.createElement("path",{d:"M5.5 7L18.5 7"}))},exports.highlightPlugin=function(t){var r=Object.assign({},{trigger:exports.Trigger.TextSelection},t),a=i.useMemo((function(){return e.createStore({highlightState:c,trigger:r.trigger})}),[]);return{install:function(e){a.update("jumpToDestination",e.jumpToDestination),a.update("getPagesContainer",e.getPagesContainer)},onViewerStateChange:function(e){return a.update("rotation",e.rotation),e},onTextLayerRender:function(t){var i,r=(i=t,function(e){if(a.get("trigger")!==exports.Trigger.None&&0===e.button){var t=i.ele,r=t.getBoundingClientRect(),o=a.get("highlightState");if(o.type===n.Selected){var l=e.clientY-r.top,h=e.clientX-r.left;o.highlightAreas.filter((function(e){return e.pageIndex===i.pageIndex})).find((function(e){var t=e.top*r.height/100,n=e.left*r.width/100,i=e.height*r.height/100,a=e.width*r.width/100;return t<=l&&l<=t+i&&n<=h&&h<=n+a}))?(window.getSelection().removeAllRanges(),a.update("highlightState",c)):a.update("highlightState",g)}else a.update("highlightState",c);var s=100*(e.clientY-r.top)/r.height,u=t.querySelector(".".concat(S));u&&e.target!==t&&(u.style.top="".concat(Math.max(0,s),"%"))}}),o=function(e){return function(t){if(a.get("trigger")!==exports.Trigger.None){var n=e.ele.querySelector(".".concat(S));n&&n.style.removeProperty("top")}}}(t),l=t.ele;if(t.status===e.LayerRenderStatus.PreRender){l.removeEventListener("mousedown",r),l.removeEventListener("mouseup",o);var h=l.querySelector(".".concat(S));h&&l.removeChild(h)}else if(t.status===e.LayerRenderStatus.DidRender&&(l.addEventListener("mousedown",r),l.addEventListener("mouseup",o),l.setAttribute(p,"true"),l.querySelectorAll(".rpv-core__text-layer-text").forEach((function(e){return e.setAttribute(v,"".concat(t.pageIndex))})),!l.querySelector(".".concat(S)))){var s=document.createElement("div");s.classList.add(S),s.classList.add("rpv-core__text-layer-text--not"),l.appendChild(s)}},renderPageLayer:function(e){return i.createElement(i.Fragment,null,i.createElement(l,{canvasLayerRef:e.canvasLayerRef,canvasLayerRendered:e.canvasLayerRendered,pageIndex:e.pageIndex,store:a,textLayerRef:e.textLayerRef,textLayerRendered:e.textLayerRendered}),i.createElement(f,{pageIndex:e.pageIndex,renderHighlightContent:r.renderHighlightContent,renderHighlightTarget:r.renderHighlightTarget,renderHighlights:r.renderHighlights,store:a}))},renderViewer:function(e){var t=e.slot;return t.subSlot&&t.subSlot.children&&(t.subSlot.children=i.createElement(i.Fragment,null,i.createElement(y,{store:a}),t.subSlot.children)),t},jumpToHighlightArea:function(e){var t=a.get("jumpToDestination");if(t){t({pageIndex:e.pageIndex,bottomOffset:function(t,n){return(100-e.top)*n/100},leftOffset:function(t,n){return(100-e.left)*t/100}})}},switchTrigger:function(e){a.update("trigger",e)}}};
